<%- include('../partials/header') %>

<section class="dashboard">
    <div class="container">
        <div class="dashboard-header">
            <h1>Dashboard - Welcome, <%= user.business_name %></h1>
            <p>Manage your portfolio and services</p>
        </div>
        
        <div class="dashboard-content">
            <!-- Profile Section -->
            <div class="dashboard-section">
                <h2>Your Profile</h2>
                <div class="profile-info">
                    <div class="profile-details">
                        <p><strong>Business Name:</strong> <%= user.business_name %></p>
                        <p><strong>Username:</strong> <%= user.username %></p>
                        <p><strong>Email:</strong> <%= user.email %></p>
                    </div>
                    <div class="profile-edit">
                        <button class="btn btn-secondary" id="editProfileBtn">Edit Profile</button>
                    </div>
                </div>
            </div>
            
            <!-- Services Section -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2>Your Services</h2>
                    <button class="btn btn-primary" id="addServiceBtn">Add Service</button>
                </div>
                
                <div class="services-list">
                    <% if(services && services.length > 0) { %>
                        <% services.forEach(service => { %>
                            <div class="service-item" data-id="<%= service.id %>">
                                <div class="service-info">
                                    <h3><%= service.title %></h3>
                                    <p><%= service.description %></p>
                                    <% if(service.price) { %>
                                        <p class="price">$<%= service.price %></p>
                                    <% } %>
                                </div>
                                <div class="service-actions">
                                    <button class="btn btn-secondary edit-service" data-id="<%= service.id %>">Edit</button>
                                    <button class="btn btn-danger delete-service" data-id="<%= service.id %>">Delete</button>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p>No services added yet.</p>
                    <% } %>
                </div>
            </div>
            
            <!-- Portfolio Section -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2>Your Portfolio</h2>
                    <button class="btn btn-primary" id="addPortfolioBtn">Add Project</button>
                </div>
                
                <div class="portfolio-grid">
                    <% if(portfolioItems && portfolioItems.length > 0) { %>
                        <% portfolioItems.forEach(item => { %>
                            <div class="portfolio-item" data-id="<%= item.id %>">
                                <img src="<%= item.image_url || '/images/default-project.jpg' %>" alt="<%= item.title %>">
                                <div class="portfolio-info">
                                    <h3><%= item.title %></h3>
                                    <p><%= item.description %></p>
                                    <div class="portfolio-actions">
                                        <button class="btn btn-secondary edit-portfolio" data-id="<%= item.id %>">Edit</button>
                                        <button class="btn btn-danger delete-portfolio" data-id="<%= item.id %>">Delete</button>
                                    </div>
                                </div>
                            </div>
                        <% }) %>
                    <% } else { %>
                        <p>No portfolio items added yet.</p>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modals -->
<div id="serviceModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="serviceModalTitle">Add Service</h2>
        <form id="serviceForm">
            <input type="hidden" id="serviceId" name="id">
            <div class="form-group">
                <label for="serviceTitle">Title</label>
                <input type="text" id="serviceTitle" name="title" required>
            </div>
            <div class="form-group">
                <label for="serviceDescription">Description</label>
                <textarea id="serviceDescription" name="description" rows="4"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="servicePrice">Price ($)</label>
                    <input type="number" id="servicePrice" name="price" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="serviceDuration">Duration</label>
                    <input type="text" id="serviceDuration" name="duration">
                </div>
            </div>
            <div class="form-group">
                <label for="serviceCategory">Category</label>
                <select id="serviceCategory" name="category">
                    <option value="general">General Repairs</option>
                    <option value="carpentry">Carpentry</option>
                    <option value="painting">Painting</option>
                    <option value="electrical">Electrical</option>
                    <option value="plumbing">Plumbing</option>
                    <option value="drywall">Drywall</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="serviceImageUrl">Image URL</label>
                <input type="url" id="serviceImageUrl" name="imageUrl">
            </div>
            <button type="submit" class="btn btn-primary">Save Service</button>
        </form>
    </div>
</div>

<div id="portfolioModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="portfolioModalTitle">Add Portfolio Item</h2>
        <form id="portfolioForm">
            <input type="hidden" id="portfolioId" name="id">
            <div class="form-group">
                <label for="portfolioTitle">Project Title</label>
                <input type="text" id="portfolioTitle" name="title" required>
            </div>
            <div class="form-group">
                <label for="portfolioDescription">Description</label>
                <textarea id="portfolioDescription" name="description" rows="4"></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="portfolioImageUrl">Image URL</label>
                    <input type="url" id="portfolioImageUrl" name="imageUrl" required>
                </div>
                <div class="form-group">
                    <label for="portfolioCategory">Category</label>
                    <select id="portfolioCategory" name="category">
                        <option value="general">General Repairs</option>
                        <option value="carpentry">Carpentry</option>
                        <option value="painting">Painting</option>
                        <option value="electrical">Electrical</option>
                        <option value="plumbing">Plumbing</option>
                        <option value="drywall">Drywall</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="portfolioClientName">Client Name</label>
                    <input type="text" id="portfolioClientName" name="clientName">
                </div>
                <div class="form-group">
                    <label for="portfolioDateCompleted">Date Completed</label>
                    <input type="date" id="portfolioDateCompleted" name="dateCompleted">
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Save Project</button>
        </form>
    </div>
</div>

<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fff;
    margin: 5% auto;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 600px;
    position: relative;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    position: absolute;
    right: 15px;
    top: 10px;
}

.close:hover {
    color: #000;
}
</style>

<script>
// Modal elements
const serviceModal = document.getElementById('serviceModal');
const portfolioModal = document.getElementById('portfolioModal');
const closeButtons = document.querySelectorAll('.close');

// Open modals
document.getElementById('addServiceBtn').addEventListener('click', () => {
    document.getElementById('serviceForm').reset();
    document.getElementById('serviceModalTitle').textContent = 'Add Service';
    document.getElementById('serviceId').value = '';
    serviceModal.style.display = 'block';
});

document.getElementById('addPortfolioBtn').addEventListener('click', () => {
    document.getElementById('portfolioForm').reset();
    document.getElementById('portfolioModalTitle').textContent = 'Add Portfolio Item';
    document.getElementById('portfolioId').value = '';
    portfolioModal.style.display = 'block';
});

// Close modals
closeButtons.forEach(button => {
    button.addEventListener('click', () => {
        serviceModal.style.display = 'none';
        portfolioModal.style.display = 'none';
    });
});

// Close modal when clicking outside
window.addEventListener('click', (event) => {
    if (event.target === serviceModal) {
        serviceModal.style.display = 'none';
    }
    if (event.target === portfolioModal) {
        portfolioModal.style.display = 'none';
    }
});

// Service form submission
document.getElementById('serviceForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const serviceData = Object.fromEntries(formData);
    
    try {
        const serviceId = serviceData.id;
        let response;
        
        if(serviceId) {
            // Update existing service
            response = await fetch(`/api/services/${serviceId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(serviceData)
            });
        } else {
            // Create new service
            response = await fetch('/api/services', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(serviceData)
            });
        }
        
        if(response.ok) {
            serviceModal.style.display = 'none';
            location.reload(); // Refresh the page to show updated content
        } else {
            const result = await response.json();
            alert(result.message || 'Operation failed');
        }
    } catch (error) {
        alert('An error occurred');
        console.error(error);
    }
});

// Portfolio form submission
document.getElementById('portfolioForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const portfolioData = Object.fromEntries(formData);
    
    try {
        const portfolioId = portfolioData.id;
        let response;
        
        if(portfolioId) {
            // Update existing portfolio item
            response = await fetch(`/api/portfolio/${portfolioId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(portfolioData)
            });
        } else {
            // Create new portfolio item
            response = await fetch('/api/portfolio', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(portfolioData)
            });
        }
        
        if(response.ok) {
            portfolioModal.style.display = 'none';
            location.reload(); // Refresh the page to show updated content
        } else {
            const result = await response.json();
            alert(result.message || 'Operation failed');
        }
    } catch (error) {
        alert('An error occurred');
        console.error(error);
    }
});

// Edit service
document.querySelectorAll('.edit-service').forEach(button => {
    button.addEventListener('click', async (e) => {
        const serviceId = e.target.dataset.id;
        
        try {
            // In a real implementation, you would fetch the service data
            // For now, we'll just prefill the form with placeholder values
            document.getElementById('serviceModalTitle').textContent = 'Edit Service';
            document.getElementById('serviceId').value = serviceId;
            
            // Fetch service details and populate form
            // This would be implemented in a real application
            
            serviceModal.style.display = 'block';
        } catch (error) {
            console.error(error);
        }
    });
});

// Delete service
document.querySelectorAll('.delete-service').forEach(button => {
    button.addEventListener('click', async (e) => {
        const serviceId = e.target.dataset.id;
        
        if(confirm('Are you sure you want to delete this service?')) {
            try {
                const response = await fetch(`/api/services/${serviceId}`, {
                    method: 'DELETE'
                });
                
                if(response.ok) {
                    location.reload(); // Refresh the page to show updated content
                } else {
                    const result = await response.json();
                    alert(result.message || 'Failed to delete service');
                }
            } catch (error) {
                alert('An error occurred');
                console.error(error);
            }
        }
    });
});

// Edit portfolio item
document.querySelectorAll('.edit-portfolio').forEach(button => {
    button.addEventListener('click', async (e) => {
        const portfolioId = e.target.dataset.id;
        
        try {
            document.getElementById('portfolioModalTitle').textContent = 'Edit Portfolio Item';
            document.getElementById('portfolioId').value = portfolioId;
            
            // Fetch portfolio details and populate form
            // This would be implemented in a real application
            
            portfolioModal.style.display = 'block';
        } catch (error) {
            console.error(error);
        }
    });
});

// Delete portfolio item
document.querySelectorAll('.delete-portfolio').forEach(button => {
    button.addEventListener('click', async (e) => {
        const portfolioId = e.target.dataset.id;
        
        if(confirm('Are you sure you want to delete this portfolio item?')) {
            try {
                const response = await fetch(`/api/portfolio/${portfolioId}`, {
                    method: 'DELETE'
                });
                
                if(response.ok) {
                    location.reload(); // Refresh the page to show updated content
                } else {
                    const result = await response.json();
                    alert(result.message || 'Failed to delete portfolio item');
                }
            } catch (error) {
                alert('An error occurred');
                console.error(error);
            }
        }
    });
});
</script>